<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Логи ESP32</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #3e3e3e; }
        h1 { font-size: 24px; color: #ffffff; }
        .controls { display: flex; gap: 10px; }
        button { padding: 8px 16px; background: #0e639c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #1177bb; }
        button:active { background: #0a4d73; }
        .auto-scroll { display: flex; align-items: center; gap: 8px; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .log-container { background: #252526; border: 1px solid #3e3e3e; border-radius: 4px; padding: 15px; height: calc(100vh - 150px); overflow-y: auto; font-size: 13px; line-height: 1.6; }
        .log-entry { margin-bottom: 4px; word-wrap: break-word; }
        .log-entry.error { color: #f48771; }
        .log-entry.warn { color: #dcdcaa; }
        .log-entry.info { color: #4ec9b0; }
        .log-entry.debug { color: #9cdcfe; }
        .status { margin-top: 10px; padding: 8px; background: #2d2d30; border-radius: 4px; font-size: 12px; color: #858585; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Логи ESP32</h1>
            <div class="controls">
                <div class="auto-scroll">
                    <input type="checkbox" id="autoScroll" checked>
                    <label for="autoScroll">Автопрокрутка</label>
                </div>
                <button onclick="clearLogs()">Очистить</button>
                <button onclick="refreshLogs()">Обновить</button>
            </div>
        </div>
        <div class="log-container" id="logContainer"></div>
        <div class="status" id="status">Загрузка...</div>
    </div>
    <script>
        let logOffset = 0;
        let autoScrollEnabled = true;
        let refreshInterval = null;
        const logContainer = document.getElementById("logContainer");
        const statusDiv = document.getElementById("status");
        const autoScrollCheckbox = document.getElementById("autoScroll");
        autoScrollCheckbox.addEventListener("change", (e) => { autoScrollEnabled = e.target.checked; if (autoScrollEnabled) scrollToBottom(); });
        function scrollToBottom() { logContainer.scrollTop = logContainer.scrollHeight; }
        function getLogLevelClass(level) { switch(level) { case "E": return "error"; case "W": return "warn"; case "I": return "info"; case "D": return "debug"; default: return ""; } }
        async function fetchLogs() {
            try {
                const response = await fetch("/api/logs?offset=" + logOffset);
                if (!response.ok) throw new Error("Ошибка загрузки логов");
                const text = await response.text();
                if (text.trim().length === 0) return;
                const lines = text.split("\n").filter(line => line.trim().length > 0);
                lines.forEach(line => {
                    const entry = document.createElement("div");
                    entry.className = "log-entry";
                    const match = line.match(/^\[(\d{2}:\d{2}:\d{2})\] \[([EWID])\] \[([^\]]+)\] (.+)$/);
                    if (match) { const [, time, level, tag, message] = match; entry.className += " " + getLogLevelClass(level); entry.textContent = line; } else { entry.textContent = line; }
                    logContainer.appendChild(entry);
                });
                logOffset += lines.length;
                if (autoScrollEnabled) setTimeout(scrollToBottom, 10);
                statusDiv.textContent = "Загружено записей: " + logOffset;
            } catch (error) { statusDiv.textContent = "Ошибка: " + error.message; }
        }
        async function getLogCount() { try { const response = await fetch("/api/logs/count"); const data = await response.json(); return data.count || 0; } catch (error) { return 0; } }
        async function clearLogs() {
            if (!confirm("Очистить все логи?")) return;
            try {
                const response = await fetch("/api/logs/clear", { method: "POST" });
                if (response.ok) { logContainer.innerHTML = ""; logOffset = 0; statusDiv.textContent = "Логи очищены"; }
            } catch (error) { statusDiv.textContent = "Ошибка: " + error.message; }
        }
        function refreshLogs() { fetchLogs(); }
        function startAutoRefresh() {
            refreshInterval = setInterval(async () => {
                const currentCount = await getLogCount();
                if (currentCount > logOffset) await fetchLogs();
            }, 1000);
        }
        function stopAutoRefresh() { if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; } }
        window.addEventListener("beforeunload", () => { stopAutoRefresh(); });
        fetchLogs();
        startAutoRefresh();
    </script>
</body>
</html>

